{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Majulah Shop - Products</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}

<div 
  class="relative bg-gray-800 bg-cover bg-center"
  style="background-image: url('https://images.unsplash.com/photo-1552667466-07770ae110d0?auto-format&fit=crop&q=80&w=2670');">
  <div class="absolute inset-0 bg-black bg-opacity-60"></div>
  <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-32 text-center text-white">
    <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-tight">
      <span class="block">Gear Up for Glory</span>
    </h1>
    <p class="mt-6 max-w-2xl mx-auto text-lg sm:text-xl text-gray-300">
      Your one-stop destination for premium football kits, boots, and sportswear.
    </p>
    <div class="mt-8">
      <a href="#products" class="inline-block bg-red-600 text-white font-bold text-lg px-8 py-4 rounded-lg shadow-lg transition-transform duration-300 hover:bg-red-700 hover:scale-105">
        Shop Now
      </a>
    </div>
  </div>
</div>

<div id="products" class="bg-gray-100 w-full">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="mb-12">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">Explore the Collection</h2>
          <p class="mt-2 text-base text-gray-600">Find the latest drops and essential gear.</p>
        </div>
        <div class="mt-4 sm:mt-0 flex items-center space-x-3">
          <button id="filter-all" class="filter-btn bg-red-600 text-white px-4 py-2 rounded-md font-medium transition-colors">All Products</button>
          <button id="filter-my" class="filter-btn bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-medium transition-colors hover:bg-red-600 hover:text-white">My Products</button>
          <button id="refresh-btn" class="p-2 text-gray-500 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors" title="Refresh Products">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
            </svg>
          </button>
        </div>
      </div>
      {% if user.is_authenticated %}
      <div class="mt-6 p-4 bg-white rounded-lg border border-gray-200">
          <div class="text-sm text-gray-600">
            Last login: {{ last_login }}
          </div>
      </div>
      {% endif %}
    </div>

    <div id="loading" class="hidden text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-red-600"></div>
        <p class="mt-4 text-gray-600">Loading products...</p>
    </div>
    <div id="error" class="hidden bg-red-50 border border-red-200 text-red-800 px-6 py-4 rounded-lg text-center">
        <h3 class="font-bold">Oops! Something went wrong.</h3>
        <p>We couldn't fetch the products. Please try again later.</p>
    </div>
    <div id="grid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></div>
    <div id="empty" class="hidden"></div>
  </div>
</div>

<button id="show-add-product-modal-btn" class="fixed bottom-8 right-8 bg-red-600 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-3xl hover:bg-red-700 transition-transform hover:scale-110 z-40">
    +
</button>

<div id="productModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 transition-opacity duration-300 opacity-0">
  <div id="productModalContent" class="bg-white rounded-lg shadow-lg w-11/12 sm:w-3/5 md:w-1/2 lg:w-2/5 xl:w-1/3 max-h-screen overflow-y-auto transform opacity-0 scale-95 transition-all duration-300">
    <div class="flex items-center justify-between p-4 border-b">
        <h3 id="modal-title" class="text-xl font-semibold text-gray-900">Add New Product</h3>
        <button type="button" class="text-gray-400 hover:text-gray-900" onclick="hideProductModal()">
            <span class="sr-only">Close modal</span>
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
        </button>
    </div>
    <form id="productForm" class="p-6 space-y-4">
        {% csrf_token %}
        {% for field in form %}
            <div>
                <label for="{{ field.id_for_label }}" class="block mb-2 text-sm font-medium text-gray-900">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}<p class="mt-1 text-xs text-gray-500">{{ field.help_text }}</p>{% endif %}
                {% for error in field.errors %}<p class="mt-1 text-xs text-red-600">{{ error }}</p>{% endfor %}
            </div>
        {% endfor %}
        <div class="flex justify-end pt-4 border-t">
            <button type="button" onclick="hideProductModal()" class="text-gray-500 bg-white hover:bg-gray-100 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900">Cancel</button>
            <button type="submit" id="submitProduct" class="text-white bg-red-600 hover:bg-red-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center ml-3">Add Product</button>
        </div>
    </form>
  </div>
</div>

<div id="deleteConfirmModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50 transition-opacity duration-300 opacity-0">
  <div id="deleteModalContent" class="bg-white rounded-lg shadow-lg w-11/12 sm:w-2/5 md:w-1/3 lg:w-1/4 max-h-screen overflow-y-auto transform opacity-0 scale-95 transition-all duration-300">
    <div class="p-6 text-center">
        <svg aria-hidden="true" class="mx-auto mb-4 w-14 h-14 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
        <h3 class="mb-5 text-lg font-normal text-gray-500">Are you sure you want to delete this product?</h3>
        <button id="confirm-delete-btn" type="button" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center mr-2">
            Yes, I'm sure
        </button>
        <button id="cancel-delete-btn" type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-gray-200 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10">
            No, cancel
        </button>
    </div>
  </div>
</div>


<script>
// --- KONFIGURASI ---
const PRODUCTS_API_ENDPOINT = "{% url 'main:show_json' %}";
const ADD_PRODUCT_API_ENDPOINT = "{% url 'main:add_product_ajax' %}";
const DELETE_API_ENDPOINT = "{% url 'main:delete_product_ajax' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
const DUMMY_UUID = '00000000-0000-0000-0000-000000000000';

// --- ELEMEN DOM ---
const loadingContainer = document.getElementById('loading');
const errorContainer = document.getElementById('error');
const gridContainer = document.getElementById('grid');
const emptyContainer = document.getElementById('empty');
const allFilterBtn = document.getElementById('filter-all');
const myFilterBtn = document.getElementById('filter-my');
const refreshBtn = document.getElementById('refresh-btn');
const productModal = document.getElementById('productModal');
const productForm = document.getElementById('productForm');
const showModalBtn = document.getElementById('show-add-product-modal-btn');
const deleteConfirmModal = document.getElementById('deleteConfirmModal');
const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
const cancelDeleteBtn = document.getElementById('cancel-delete-btn');

// --- VARIABEL STATE ---
let activeFilter = 'all';
let allProductsData = [];

// --- FUNGSI-FUNGSI ---

function showContainer(containerToShow) {
    [loadingContainer, errorContainer, gridContainer, emptyContainer].forEach(container => {
        container.classList.toggle('hidden', container !== containerToShow);
    });
}

function buildProductCardHTML(product) {
    const fields = product.fields;
    const pk = product.pk;
    const isOwner = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(fields.user);
    const detailUrl = `{% url 'main:show_product' '00000000-0000-0000-0000-000000000000' %}`.replace(DUMMY_UUID, pk);
    const editUrl = `{% url 'main:edit_product' '00000000-0000-0000-0000-000000000000' %}`.replace(DUMMY_UUID, pk);

    let userActions = `<a href="${detailUrl}" class="font-semibold text-red-600 hover:text-red-500 text-sm transition-colors">View Details â†’</a>`;
    if (isOwner) {
        userActions = `
            <div class="flex items-center justify-between w-full">
                <a href="${detailUrl}" class="font-semibold text-red-600 hover:text-red-500 text-sm transition-colors">View Details</a>
                <div class="flex space-x-3">
                    <a href="${editUrl}" class="text-gray-500 hover:text-gray-800 text-sm transition-colors font-medium">Edit</a>
                    <button data-id="${pk}" class="delete-btn text-red-600 hover:text-red-500 text-sm transition-colors font-medium">Delete</button>
                </div>
            </div>`;
    }
    
    const username = fields.username || "Anonymous";

    return `
        <article class="bg-white rounded-lg border border-gray-200 flex flex-col overflow-hidden transition-all duration-300 hover:shadow-xl hover:-translate-y-1 group">
            <a href="${detailUrl}" class="block aspect-[4/3] overflow-hidden relative">
                <img src="${fields.thumbnail || '{% static "image/no-product.png" %}'}" alt="${fields.name}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
            </a>
            <div class="p-5 flex flex-col flex-grow">
                <h3 class="text-lg font-bold text-gray-900 mb-1 line-clamp-2 leading-tight">
                    <a href="${detailUrl}" class="hover:text-red-600 transition-colors">${fields.name}</a>
                </h3>
                <p class="text-xs text-gray-500 mb-3">By ${username}</p>
                <div class="mt-auto">
                    <p class="text-sm text-gray-500">Price</p>
                    <p class="text-2xl font-bold text-red-700">Rp ${fields.price}</p>
                </div>
                <div class="pt-4 border-t border-gray-100 mt-4">${userActions}</div>
            </div>
        </article>`;
}

async function fetchAllProducts() {
    showContainer(loadingContainer);
    refreshBtn.querySelector('svg').classList.add('animate-spin');
    try {
        await new Promise(resolve => setTimeout(resolve, 500));
        const response = await fetch(PRODUCTS_API_ENDPOINT);
        if (!response.ok) throw new Error('Network response was not ok.');
        allProductsData = await response.json();
        filterAndDisplayProducts();
    } catch (error) {
        console.error("Failed to fetch products:", error);
        showContainer(errorContainer);
    } finally {
        refreshBtn.querySelector('svg').classList.remove('animate-spin');
    }
}

function filterAndDisplayProducts() {
    const productsToShow = activeFilter === 'all' ? allProductsData : allProductsData.filter(p => p.fields.user == CURRENT_USER_ID);
    if (productsToShow.length === 0) {
        emptyContainer.innerHTML = `
            <div class="bg-white rounded-lg border border-gray-200 p-12 text-center">
                <div class="w-24 h-24 mx-auto mb-4 text-red-300">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-full h-full"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" /></svg>
                </div>
                <h3 class="text-xl font-medium text-gray-900 mb-2">No Products to Display</h3>
                <p class="text-gray-500 mb-6">It looks empty in here. Be the first to add a product!</p>
                <button onclick="showProductModal()" class="inline-flex items-center px-6 py-3 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 shadow-sm">Add a New Product</button>
            </div>`;
        showContainer(emptyContainer);
    } else {
        gridContainer.innerHTML = productsToShow.map(buildProductCardHTML).join('');
        showContainer(gridContainer);
        attachDeleteListeners();
    }
}

function attachDeleteListeners() {
    document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', handleDeleteClick));
}

function handleDeleteClick(event) {
    const productId = event.target.dataset.id;
    showDeleteConfirmModal(productId);
}

function showProductModal() {
    productForm.reset();
    const modalContent = document.getElementById('productModalContent');
    productModal.classList.remove('hidden');
    setTimeout(() => {
        productModal.classList.remove('opacity-0');
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);
}

function hideProductModal() {
    const modalContent = document.getElementById('productModalContent');
    productModal.classList.add('opacity-0');
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    setTimeout(() => {
        productModal.classList.add('hidden');
    }, 300); 
}

function showDeleteConfirmModal(productId) {
    const modalContent = document.getElementById('deleteModalContent');
    confirmDeleteBtn.dataset.id = productId;
    deleteConfirmModal.classList.remove('hidden');
    setTimeout(() => {
        deleteConfirmModal.classList.remove('opacity-0');
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
    }, 50);
}

function hideDeleteConfirmModal() {
    const modalContent = document.getElementById('deleteModalContent');
    deleteConfirmModal.classList.add('opacity-0');
    modalContent.classList.remove('opacity-100', 'scale-100');
    modalContent.classList.add('opacity-0', 'scale-95');
    setTimeout(() => {
        deleteConfirmModal.classList.add('hidden');
    }, 300);
}

function updateFilterButtons() {
    document.querySelectorAll('.filter-btn').forEach(btn => {
        const isActive = (btn.id.includes(activeFilter));
        btn.classList.toggle('bg-red-600', isActive);
        btn.classList.toggle('text-white', isActive);
        btn.classList.toggle('bg-white', !isActive);
        btn.classList.toggle('text-gray-700', !isActive);
    });
}

document.addEventListener('DOMContentLoaded', () => {
    fetchAllProducts();
    refreshBtn.addEventListener('click', fetchAllProducts);
    showModalBtn.addEventListener('click', showProductModal);

    allFilterBtn.addEventListener('click', () => {
        activeFilter = 'all';
        updateFilterButtons();
        filterAndDisplayProducts();
    });
    myFilterBtn.addEventListener('click', () => {
        activeFilter = 'my';
        updateFilterButtons();
        filterAndDisplayProducts();
    });

    productForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(productForm);
        try {
            const response = await fetch(ADD_PRODUCT_API_ENDPOINT, { method: "POST", body: formData });
            const result = await response.json();
            if (result.status === "success") {
                showToast('Success', result.message, 'success');
                hideProductModal();
                await fetchAllProducts();
            } else {
                showToast('Error', 'Failed to add product. Please check the form.', 'error');
            }
        } catch (error) {
            showToast('Error', 'Could not connect to server.', 'error');
        }
    });

    cancelDeleteBtn.addEventListener('click', hideDeleteConfirmModal);
    confirmDeleteBtn.addEventListener('click', async (event) => {
        const productId = event.target.dataset.id;
        try {
            const response = await fetch(DELETE_API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ id: productId })
            });
            const result = await response.json();
            hideDeleteConfirmModal();
            if (result.status === 'success') {
                showToast('Success', result.message, 'success');
                await fetchAllProducts();
            } else {
                showToast('Error', result.message, 'error');
            }
        } catch (error) {
            hideDeleteConfirmModal();
            showToast('Error', 'Could not connect to the server.', 'error');
        }
    });
});

window.addEventListener('pageshow', function(event) {
    if (event.persisted) {
        fetchAllProducts();
    }
});
</script>
{% endblock content %}